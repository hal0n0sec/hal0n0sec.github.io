# 「IoT」IC卡原理学习



## 0x01 IC卡概述

目前我们接触到的门禁卡、电梯卡、水卡等，基本上可以分为两大类，即ID卡和IC卡。

### 1.1 ID卡与IC卡的区别

ID卡全程`Identification Card`，即 身份识别卡，这种卡容量有限，所以只能存储卡号，理论上也不可重复擦写，且安全性很差，现在淘宝就可以买到可以更改卡号的白卡，目前已经不是主流方案了。因为卡自身没有存储功能的原因，卡片持有者的权限、功能完全依赖于联网系统，优势在于卡和读卡器价格便宜，此外，ID卡多使用低频通讯（125Khz）。

IC卡全称为`Integrated Circuit Card`，即 集成电路卡，带存储器，数据可以分区，可以加密。IC卡所记录内容可以反复擦写，甚至带微处理器CPU，也就是所谓的CPU卡。由于卡自身可以记录卡号、用户资料、权限、消费余额等信息，故可以脱离联网系统，多使用于高频段（13.56MHz）。

### 1.2 如何区分ID卡与IC卡

**方法一：通过灯光透视卡片天线形状分辨**

在暗光环境下，打开手机手电筒功能，从卡的另外一边打光过来，可以看到卡片内部天线形状（圆角矩形为IC卡，圆形为ID卡，如果都具备，那么就是双频卡）。

> 以上分辨的方法仅适用于标准大卡（也就是和银行卡一样大小的那种），小卡不能按此方法分辨，另外如果是酒店宾馆的房卡，如果线圈呈现圆形，这种不是ID卡，而是特殊加密卡，不可复制。

**方法二：通过卡面编号进行分辨**

如果卡的表面带有`00`开头的10位数或者18位数的编号，一般情况下多为ID卡。

如果是钥匙扣的那种，没有编号的一般多为IC钥匙扣。

**方法三：通过安卓手机的NFC功能进行分辨**

带有NFC功能的安卓手机，会对IC类型的卡产生感应手，由此可以用来分辨IC和ID卡。

可以在安装应用市场上下载 Mifare Classic Toll，这个工具进行检测IC卡的具体类型和加密程度。



### 1.3 IC卡主要类型

IC卡主要分为以下几种类型：

1. M0卡（`Mifare UltraLight`卡）：高频低成本卡，出厂固化UID，可存储修改数据（例如：地铁卡、公交卡），等同于M1卡的精简版，容量和功能都打了折扣。

2. M1卡（`MIFARE Classic`卡）：别称有`Mifare Standard`，`Mifare S50`，`Mifare S70`，`MF1`等，也是最普遍、出货量最大的一种卡（可以作为饭卡、学生卡、门禁卡等使用）。

   > 想要判断是否是M0卡还是M1卡，可以通过SAK值进行判断。
   >
   > ![image-20240926154222334](https://takuya-1305710862.cos.ap-shanghai.myqcloud.com/A1ways0nline/pic/image-20240926154222334.png)

3. CPU卡：顾名思义，就是内置了微处理器和随机数发生器，搭载COS片上操作系统，广泛应用于金融领域，比如常见的银行卡，同时随着M1卡的漏洞层出不穷，CPU卡也会逐步取代成为未来，破解CPU卡等同天方夜谭，最多也就是复制UID到手环或者白卡里面，使用部分的门禁功能。

4. CPU模拟卡：CPU模拟卡**由CPU部分7K**以及**M1部分1K**组成。

   CPU模拟卡目前只能破解其中的M1部分，CPU区域数据目前依旧没有破解的可能，其M1部分破解出来之后，如果扇区里面有数据，可以尝试将数据写入到UID卡中，然后测试UID卡是否可以使用电梯，根据目前的情况来说90%的CPU模拟卡数据复制到UID中无法使用电梯，仅仅只能打开门禁。

   这种情况下就说明，这张CPU模拟卡有一定有CPU的交互，可能有M1部分的交互，早期部分小区破解了CPU模拟卡之后，可以复制到UID中进行使用，其原因就是因为物业没有启用CPU部分，将CPU模拟卡当作M1卡使用，另一种是早期电梯不会同时检测CPU交互和M1交互，检测到M1部分有交互电梯就可以运行了。



以上4中是正规卡，下面的都是用于破解复制的非正规卡。



1. UID卡（`Mifare UID Chinese magic card`）：国人发明，国外称为中国魔术卡，0扇区可以随意修改，达到模拟原卡的能力，但现在许多读卡系统可以提供检测是否回应后门指令，来屏蔽它，即 UID防火墙系统。
2. CUID卡：是UID卡的升级版，区别在于UID卡是通过指令来修改0扇区的，CUID卡使用的是常规密码验证的方法写0扇区，不响应后门指令（magic指令），所以不会被检测出来。
3. FUID卡：同样是对UID卡的升级，但是相较于CUID卡，这种卡只能写一次，FUID卡写完之后会自动固化UID所在分区，就等同于M1卡，但是一旦写错卡就彻底报废了。
4. UFUID卡：FUID卡的再次升级版，可以手动固化（锁卡），此外同时具有上述的一切优点。
5. GUID卡：专门应对滚动数据的复制卡。

此外淘宝上还售卖一些冷门的类型卡，例如KUID卡、SUID卡、NUIC卡等。

另外这些卡还能分为 接触式 与 非接触式（感应式），区别在于是否露出金属触点：

- 对于非接触卡，内部环卡一周有金属线圈，没有线圈的就是感应式IC卡，有线圈的就是接触式IC卡。如果卡断了，就无法读卡了，但像银行卡这种，兼具了芯片与线圈，粘起来还能用ATM来取钱的，只是无法刷卡付款。



### 1.4 IC卡破解的原理

标准的M1卡的`EEPROM`被划分为16个扇区（Sectors），其中每个扇区由4个数据块组成，每个数据拥有16个字节（Bytes）

![image-20240926161200038](https://takuya-1305710862.cos.ap-shanghai.myqcloud.com/A1ways0nline/pic/image-20240926161200038.png)

如果是想要复制门禁，那么就与0扇区有关，0扇区中存放着卡号与厂商信息，卡号异或值可以通过前8位卡号计算得到：

![image-20240926161305177](https://takuya-1305710862.cos.ap-shanghai.myqcloud.com/A1ways0nline/pic/image-20240926161305177.png)

另外，所有的扇区的第三块都存放着2个密钥，keyA 和 keyB，默认值为12个`F`或者`0`，转化为二进制则为48个`1`或者`0`。中间为控制码，默认值为`FF078069`，即只读取验证A密码，常见的还有`08778F69`，即A密码可见可读，B密码不可见可写。对于M1卡的读写都需要A密码或者B密码，与M1卡的结构及读取权限特点有关，M1卡又可以分为 非加密、半加密、全加密三种类型，不过现在M1的加密逻辑早已经被公开，所以所有的M1加密卡都可以被破解。

**破解门禁主要就是复制0扇区的内容！！**



### 1.5 滚动码的原理

滚动码出现的需求就是UID卡可以完全复制IC卡，市面上出现了大量的复制卡。

假如IC卡内部的数据是死的，也就是不变化的，那么依样画葫芦，就像复印机一样，一张复制N张，张张都能用。等于是一把钥匙被复制，那就存在安全隐患，或者说是管理方不愿意看到的。

滚动码的原理很简单，每刷一次卡，内卡有个数据都会发生变化，比如刚开始是0，刷一次变成1了，再刷一次变成2，到9之后再刷就变回0，俗称滚动（实际情况下不一定0-9滚动，变化的类型有很多种）。

![image-20240926162949105](https://takuya-1305710862.cos.ap-shanghai.myqcloud.com/A1ways0nline/pic/image-20240926162949105.png)

不光卡内的滚动码会变化，读卡器也会记录滚动码，只有当卡内的滚动码和读卡器保存的滚动码相同，才会被认为是正常的卡。

而复制的卡，因为卡内的数据不会同步，正常的卡刷过之后，滚动码变化了，而复制卡内的滚动码还是原来的数字，就和读卡器内最新的滚动码不一致，那么就会被判断为复制卡。

现在高级一些的防复制防火墙，甚至一旦发现是复制卡，会破坏卡片，或者把卡片拉黑，导致正常卡也无法使用了。







[参考文章：梯控、IC卡滚动码防复制原理和破解](https://nfctool.cn/4465/elementor-4465)

[参考文章：记一次破解校园门禁的经验和所学](https://linux.do/t/topic/216481)