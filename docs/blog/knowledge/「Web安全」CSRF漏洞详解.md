# CSRF漏洞详解



## 0x01 什么是CSRF

CSRF（`Cross Site Request Forgery` ，跨站请求伪造），与XSS有点类似，攻击者将诱导受害者访问第三方网站，在第三方网站中 向被攻击网站发送跨站请求，也就是说，攻击者可以盗用受害者的身份，以受害者的名义发送恶意请求。



## 0x02 CSRF漏洞原理

举个简单的例子，假设现在你又一个银行账户，并且你已经登录到了银行的官方网站，在这个网站上，你可以转账给其他人，为了安全起见，银行要求你在每次转账时要输入密码。

现在，假设你收到了一封电子邮件，邮件中包含了一个链接，声称是一个抽奖活动的页面，然后你在好奇心的驱使下点击了这个链接，打开了一个新的网站页面。

然而这个打开的新网页是由攻击者构建的，虽然这个网页看起来很正常，但是它里面隐藏了一些内容：**当网页加载时，他会自动向你的银行网站发送一个转账请求，将你的钱转账到一个攻击者指定的账户里面**。

> CSRF漏洞的本质
>
> CSRF漏洞的本质在于利用用户在目标网站已经登录的状态，攻击者不需要知道用户的密码或者其他的敏感信息，只需要诱导用户访问一个恶意网站或者点击一个恶意链接即可。

由于你已经登录到了银行的网站，并且浏览器中保存了你的登录状态（例如Cookie），银行网站则会认为这个转账请求是你本人发起的，因此不会再要求你输入密码。最终，你的钱就被攻击者全部转走了。

![CleanShot 2024-09-27 at 23.14.28@2x](https://takuya-1305710862.cos.ap-shanghai.myqcloud.com/A1ways0nline/picCleanShot%202024-09-27%20at%2023.14.28@2x.png)

在这个过程中，受害者只需要做下面2件事情，攻击者就可以完成CSRF攻击：

1. 登录受信任银行网站，并生成身份验证信息。
2. 在不登出银行网站（清除身份验证信息）的情况下，访问恶意站点。



## 0x03 CSRF漏洞分类

CSRF漏洞一般情况下可以分为 **站内** 和 **站外** 两种类型。

**CSRF站内类型**：这种类型在一定程度上是由于程序员滥用了`$_REQUEST`类变量造成的，一些敏感的操作本来是要求用户从表单提交发起`POST`请求传参给程序的，但是由于使用了`$_REQUEST`等变量，程序也接收GET请求传参，这样就给攻击者使用CSRF攻击创造了条件，一般攻击者只要把预测好的请求参数放在站内的一个帖子或者留言的图片链接里面，受害者浏览了这样的页面就会被强迫发起请求。

**CSRF站外类型**：该类型的漏洞其实就是传统意义上的外部提交数据问题，一般程序员会考虑给一些留言评论等的表单加上水印以防止SPAM问题，但是为了用户的体验感更好，一些操作可能没有做任何的限制，所以攻击者就可以先预测好请求的参数，在站外的Web页面里编写javascript脚本来伪造文件请求和自动提交的表单来实现GET、POST请求，用户在会话状态下点击链接访问了站外的Web页面，客户端就被强迫发起了请求。

> 对于SPAM的解释：`SPAM问题`指的是垃圾信息问题，具体是指未经接收者同意而发送的大量电子邮件或其他形式的信息，这些消息通常是广告、推销或者其他不相关的信息，它们会干扰用户的正常使用。



## 0x04 CSRF漏洞检测

检测CSRF漏洞简单的方式和步骤有以下几种：

1. 分析网站功能，访问目标网站的主要页面和功能点，特别是那些涉及敏感操作的部分，例如登录、注册、修改个人信息、转账等功能点。

2. 抓取一个正常请求的数据包，去掉`Referer`字段后再重新提交，如果该提交还是有效的，那么基本上可以确定是存在CSRF漏洞的。

3. 关键检查点：

   - CSRF Token

     - 查找`Token`字段

       - 例如在POST请求的表单中查找是否有隐藏的输入字段，通常命名为`csrf_token`、`anti_csrf_token`或类似的名称。

       - 检查这个Token是否每次请求的时候都会发生变化。

     - 验证Token的使用

       - 确认服务端是否对这个Token进行验证，如果没有验证或者验证不严格，那么就可能存在CSRF漏洞。

   - Cookie设置
     - 检查`SameSite`属性
       - 在`Application`标签页下的`Cookies`部分，查看相关Cookie是否设置了`SameSite=Strict`或者`SameSite=Lax`属性
       - 如果没有设置，Cookie就可能会在跨站请求中被发送，增加了CSRF的风险。
   - 请求方法
     - GET vs POST
       - 对于使用GET请求方法的敏感操作，存在CSRF的可能性更大，因为URL中可以直接被嵌入到其他网页中。
       - 对于POST方法，相比之下稍微安全一些，但是仍然需要Token的保护。

4. 构造简单的CSRF测试

   首先，在准备好的域名的服务器上构建一个HTML页面，用于发起CSRF攻击。

   对于GET类型的请求

   - 如果发现某个敏感操作是通过GET请求完成的，那么就可以快速的构建一个测试的链接：

     ```html
     <img src="http://目标网站/敏感操作？参数=恶意值" width="0" height="0">
     <!-- 例如下面这个标签 -->
     <img src="http://example.com/change_passwrod?new_password=hacked" with="0" height="0" >
     ```

   - 攻击者将这个链接给到受害者之后，受害者点击了这个链接，访问了攻击者构建的HTML页面。

   - 浏览器自动加载`<img>`标签的`src`属性指向的URL，向目标网站发送了一个GET请求，同时携带了恶意的参数。

   - 目标网站收到了这个请求之后，按照URL中的参数执行了修改密码的操作，从而实现了攻击者的目的。

   对于POST请求，可以使用 javascript 自动提交表单的方式进行快速测试

   ```html
   <form action="http://目标网站/修改密码" method="POST">
     <input type="hidden" name="new_password" value="hacked">
     <script>document.forms[0].submit();</script>
   </form>
   ```

   > ⚠️ 注意，上面提到的 GET或者POST 的这两种方式，都依赖于受害者在目标网站上都已经是登录的状态，如果受害者没有登录或者登录状态已经过期了，攻击将无法成功。



除了手动检测的方式之外，还有一些工具可以是专门针对CSRF漏洞的，例如：CSRFTester，CSRF Request Builder，[Bolt](https://github.com/s0md3v/Bolt)等。

练习：

1. Espcms存在CSRF漏洞，[利用的参考文章](https://blog.csdn.net/m0_63127854/article/details/131619867)；
2. metinfo cms存在CSRF漏洞，[漏洞版本MetInfo下载链接，提取码：pek6](https://pan.baidu.com/s/1ZgKx3BE3hmJkflJxundYSA)
3. 骑士CMS存在CSRF漏洞，[漏洞版本为4.1.24，下载链接提取码：75sx](https://pan.baidu.com/s/1U-I28J2DDTZkY1esQr9H4A)，[参考文章链接地址](https://www.cnblogs.com/wwcdg/p/15913892.html)

[参考文章：先知社区-浅谈CSRF漏洞](https://xz.aliyun.com/t/7450?time__1311=n4%2BxnD0Dy7GQDtAKx05%2BbW%3DIxmTuwBx7KQx)



